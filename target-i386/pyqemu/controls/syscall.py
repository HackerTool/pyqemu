#!/usr/bin/env python

from control import ProcessControl

#windows XP syscall table from metasploit
syscall_table = {
	0x0000:"NtAcceptConnectPort",
	0x0001:"NtAccessCheck",
	0x0002:"NtAccessCheckAndAuditAlarm",
	0x0003:"NtAccessCheckByType",
	0x0004:"NtAccessCheckByTypeAndAuditAlarm",
	0x0005:"NtAccessCheckByTypeResultList",
	0x0006:"NtAccessCheckByTypeResultListAndAuditAlarm",
	0x0007:"NtAccessCheckByTypeResultListAndAuditAlarmByHandle",
	0x0008:"NtAddAtom",
	0x0009:"NtAddBootEntry",
	0x000a:"NtAdjustGroupsToken",
	0x000b:"NtAdjustPrivilegesToken",
	0x000c:"NtAlertResumeThread",
	0x000d:"NtAlertThread",
	0x000e:"NtAllocateLocallyUniqueId",
	0x000f:"NtAllocateUserPhysicalPages",
	0x0010:"NtAllocateUuids",
	0x0011:"NtAllocateVirtualMemory",
	0x0012:"NtAreMappedFilesTheSame",
	0x0013:"NtAssignProcessToJobObject",
	0x0014:"NtCallbackReturn",
	0x0015:"NtCancelDeviceWakeupRequest",
	0x0016:"NtCancelIoFile",
	0x0017:"NtCancelTimer",
	0x0018:"NtClearEvent",
	0x0019:"NtClose",
	0x001a:"NtCloseObjectAuditAlarm",
	0x001b:"NtCompactKeys",
	0x001c:"NtCompareTokens",
	0x001d:"NtCompleteConnectPort",
	0x001e:"NtCompressKey",
	0x001f:"NtConnectPort",
	0x0020:"NtContinue",
	0x0021:"NtCreateDebugObject",
	0x0022:"NtCreateDirectoryObject",
	0x0023:"NtCreateEvent",
	0x0024:"NtCreateEventPair",
	0x0025:"NtCreateFile",
	0x0026:"NtCreateIoCompletion",
	0x0027:"NtCreateJobObject",
	0x0028:"NtCreateJobSet",
	0x0029:"NtCreateKey",
	0x0117:"NtCreateKeyedEvent",
	0x002a:"NtCreateMailslotFile",
	0x002b:"NtCreateMutant",
	0x002c:"NtCreateNamedPipeFile",
	0x002d:"NtCreatePagingFile",
	0x002e:"NtCreatePort",
	0x002f:"NtCreateProcess",
	0x0030:"NtCreateProcessEx",
	0x0031:"NtCreateProfile",
	0x0032:"NtCreateSection",
	0x0033:"NtCreateSemaphore",
	0x0034:"NtCreateSymbolicLinkObject",
	0x0035:"NtCreateThread",
	0x0036:"NtCreateTimer",
	0x0037:"NtCreateToken",
	0x0038:"NtCreateWaitablePort",
	0x0039:"NtDebugActiveProcess",
	0x003a:"NtDebugContinue",
	0x003b:"NtDelayExecution",
	0x003c:"NtDeleteAtom",
	0x003d:"NtDeleteBootEntry",
	0x003e:"NtDeleteFile",
	0x003f:"NtDeleteKey",
	0x0040:"NtDeleteObjectAuditAlarm",
	0x0041:"NtDeleteValueKey",
	0x0042:"NtDeviceIoControlFile",
	0x0043:"NtDisplayString",
	0x0044:"NtDuplicateObject",
	0x0045:"NtDuplicateToken",
	0x0046:"NtEnumerateBootEntries",
	0x0047:"NtEnumerateKey",
	0x0048:"NtEnumerateSystemEnvironmentValuesEx",
	0x0049:"NtEnumerateValueKey",
	0x004a:"NtExtendSection",
	0x004b:"NtFilterToken",
	0x004c:"NtFindAtom",
	0x004d:"NtFlushBuffersFile",
	0x004e:"NtFlushInstructionCache",
	0x004f:"NtFlushKey",
	0x0050:"NtFlushVirtualMemory",
	0x0051:"NtFlushWriteBuffer",
	0x0052:"NtFreeUserPhysicalPages",
	0x0053:"NtFreeVirtualMemory",
	0x0054:"NtFsControlFile",
	0x0055:"NtGetContextThread",
	0x0056:"NtGetDevicePowerState",
	0x0057:"NtGetPlugPlayEvent",
	0x0058:"NtGetWriteWatch",
	0x0059:"NtImpersonateAnonymousToken",
	0x005a:"NtImpersonateClientOfPort",
	0x005b:"NtImpersonateThread",
	0x005c:"NtInitializeRegistry",
	0x005d:"NtInitiatePowerAction",
	0x005e:"NtIsProcessInJob",
	0x005f:"NtIsSystemResumeAutomatic",
	0x0060:"NtListenPort",
	0x0061:"NtLoadDriver",
	0x0062:"NtLoadKey",
	0x0063:"NtLoadKey2",
	0x0064:"NtLockFile",
	0x0065:"NtLockProductActivationKeys",
	0x0066:"NtLockRegistryKey",
	0x0067:"NtLockVirtualMemory",
	0x0068:"NtMakePermanentObject",
	0x0069:"NtMakeTemporaryObject",
	0x006a:"NtMapUserPhysicalPages",
	0x006b:"NtMapUserPhysicalPagesScatter",
	0x006c:"NtMapViewOfSection",
	0x006d:"NtModifyBootEntry",
	0x006e:"NtNotifyChangeDirectoryFile",
	0x006f:"NtNotifyChangeKey",
	0x0070:"NtNotifyChangeMultipleKeys",
	0x0071:"NtOpenDirectoryObject",
	0x0072:"NtOpenEvent",
	0x0073:"NtOpenEventPair",
	0x0074:"NtOpenFile",
	0x0075:"NtOpenIoCompletion",
	0x0076:"NtOpenJobObject",
	0x0077:"NtOpenKey",
	0x0118:"NtOpenKeyedEvent",
	0x0078:"NtOpenMutant",
	0x0079:"NtOpenObjectAuditAlarm",
	0x007a:"NtOpenProcess",
	0x007b:"NtOpenProcessToken",
	0x007c:"NtOpenProcessTokenEx",
	0x007d:"NtOpenSection",
	0x007e:"NtOpenSemaphore",
	0x007f:"NtOpenSymbolicLinkObject",
	0x0080:"NtOpenThread",
	0x0081:"NtOpenThreadToken",
	0x0082:"NtOpenThreadTokenEx",
	0x0083:"NtOpenTimer",
	0x0084:"NtPlugPlayControl",
	0x0085:"NtPowerInformation",
	0x0086:"NtPrivilegeCheck",
	0x0087:"NtPrivilegeObjectAuditAlarm",
	0x0088:"NtPrivilegedServiceAuditAlarm",
	0x0089:"NtProtectVirtualMemory",
	0x008a:"NtPulseEvent",
	0x008b:"NtQueryAttributesFile",
	0x008c:"NtQueryBootEntryOrder",
	0x008d:"NtQueryBootOptions",
	0x008e:"NtQueryDebugFilterState",
	0x008f:"NtQueryDefaultLocale",
	0x0090:"NtQueryDefaultUILanguage",
	0x0091:"NtQueryDirectoryFile",
	0x0092:"NtQueryDirectoryObject",
	0x0093:"NtQueryEaFile",
	0x0094:"NtQueryEvent",
	0x0095:"NtQueryFullAttributesFile",
	0x0096:"NtQueryInformationAtom",
	0x0097:"NtQueryInformationFile",
	0x0098:"NtQueryInformationJobObject",
	0x0099:"NtQueryInformationPort",
	0x009a:"NtQueryInformationProcess",
	0x009b:"NtQueryInformationThread",
	0x009c:"NtQueryInformationToken",
	0x009d:"NtQueryInstallUILanguage",
	0x009e:"NtQueryIntervalProfile",
	0x009f:"NtQueryIoCompletion",
	0x00a0:"NtQueryKey",
	0x00a1:"NtQueryMultipleValueKey",
	0x00a2:"NtQueryMutant",
	0x00a3:"NtQueryObject",
	0x00a4:"NtQueryOpenSubKeys",
	0x00a5:"NtQueryPerformanceCounter",
	0x011b:"NtQueryPortInformationProcess",
	0x00a6:"NtQueryQuotaInformationFile",
	0x00a7:"NtQuerySection",
	0x00a8:"NtQuerySecurityObject",
	0x00a9:"NtQuerySemaphore",
	0x00aa:"NtQuerySymbolicLinkObject",
	0x00ab:"NtQuerySystemEnvironmentValue",
	0x00ac:"NtQuerySystemEnvironmentValueEx",
	0x00ad:"NtQuerySystemInformation",
	0x00ae:"NtQuerySystemTime",
	0x00af:"NtQueryTimer",
	0x00b0:"NtQueryTimerResolution",
	0x00b1:"NtQueryValueKey",
	0x00b2:"NtQueryVirtualMemory",
	0x00b3:"NtQueryVolumeInformationFile",
	0x00b4:"NtQueueApcThread",
	0x00b5:"NtRaiseException",
	0x00b6:"NtRaiseHardError",
	0x00b7:"NtReadFile",
	0x00b8:"NtReadFileScatter",
	0x00b9:"NtReadRequestData",
	0x00ba:"NtReadVirtualMemory",
	0x00bb:"NtRegisterThreadTerminatePort",
	0x0119:"NtReleaseKeyedEvent",
	0x00bc:"NtReleaseMutant",
	0x00bd:"NtReleaseSemaphore",
	0x00be:"NtRemoveIoCompletion",
	0x00bf:"NtRemoveProcessDebug",
	0x00c0:"NtRenameKey",
	0x00c1:"NtReplaceKey",
	0x00c2:"NtReplyPort",
	0x00c3:"NtReplyWaitReceivePort",
	0x00c4:"NtReplyWaitReceivePortEx",
	0x00c5:"NtReplyWaitReplyPort",
	0x00c6:"NtRequestDeviceWakeup",
	0x00c7:"NtRequestPort",
	0x00c8:"NtRequestWaitReplyPort",
	0x00c9:"NtRequestWakeupLatency",
	0x00ca:"NtResetEvent",
	0x00cb:"NtResetWriteWatch",
	0x00cc:"NtRestoreKey",
	0x00cd:"NtResumeProcess",
	0x00ce:"NtResumeThread",
	0x00cf:"NtSaveKey",
	0x00d0:"NtSaveKeyEx",
	0x00d1:"NtSaveMergedKeys",
	0x00d2:"NtSecureConnectPort",
	0x00d3:"NtSetBootEntryOrder",
	0x00d4:"NtSetBootOptions",
	0x00d5:"NtSetContextThread",
	0x00d6:"NtSetDebugFilterState",
	0x00d7:"NtSetDefaultHardErrorPort",
	0x00d8:"NtSetDefaultLocale",
	0x00d9:"NtSetDefaultUILanguage",
	0x00da:"NtSetEaFile",
	0x00db:"NtSetEvent",
	0x00dc:"NtSetEventBoostPriority",
	0x00dd:"NtSetHighEventPair",
	0x00de:"NtSetHighWaitLowEventPair",
	0x00df:"NtSetInformationDebugObject",
	0x00e0:"NtSetInformationFile",
	0x00e1:"NtSetInformationJobObject",
	0x00e2:"NtSetInformationKey",
	0x00e3:"NtSetInformationObject",
	0x00e4:"NtSetInformationProcess",
	0x00e5:"NtSetInformationThread",
	0x00e6:"NtSetInformationToken",
	0x00e7:"NtSetIntervalProfile",
	0x00e8:"NtSetIoCompletion",
	0x00e9:"NtSetLdtEntries",
	0x00ea:"NtSetLowEventPair",
	0x00eb:"NtSetLowWaitHighEventPair",
	0x00ec:"NtSetQuotaInformationFile",
	0x00ed:"NtSetSecurityObject",
	0x00ee:"NtSetSystemEnvironmentValue",
	0x00ef:"NtSetSystemEnvironmentValueEx",
	0x00f0:"NtSetSystemInformation",
	0x00f1:"NtSetSystemPowerState",
	0x00f2:"NtSetSystemTime",
	0x00f3:"NtSetThreadExecutionState",
	0x00f4:"NtSetTimer",
	0x00f5:"NtSetTimerResolution",
	0x00f6:"NtSetUuidSeed",
	0x00f7:"NtSetValueKey",
	0x00f8:"NtSetVolumeInformationFile",
	0x00f9:"NtShutdownSystem",
	0x00fa:"NtSignalAndWaitForSingleObject",
	0x00fb:"NtStartProfile",
	0x00fc:"NtStopProfile",
	0x00fd:"NtSuspendProcess",
	0x00fe:"NtSuspendThread",
	0x00ff:"NtSystemDebugControl",
	0x0100:"NtTerminateJobObject",
	0x0101:"NtTerminateProcess",
	0x0102:"NtTerminateThread",
	0x0103:"NtTestAlert",
	0x0104:"NtTraceEvent",
	0x0105:"NtTranslateFilePath",
	0x0106:"NtUnloadDriver",
	0x0107:"NtUnloadKey",
	0x0108:"NtUnloadKeyEx",
	0x0109:"NtUnlockFile",
	0x010a:"NtUnlockVirtualMemory",
	0x010b:"NtUnmapViewOfSection",
	0x010c:"NtVdmControl",
	0x010d:"NtWaitForDebugEvent",
	0x011a:"NtWaitForKeyedEvent",
	0x010e:"NtWaitForMultipleObjects",
	0x010f:"NtWaitForSingleObject",
	0x0110:"NtWaitHighEventPair",
	0x0111:"NtWaitLowEventPair",
	0x0112:"NtWriteFile",
	0x0113:"NtWriteFileGather",
	0x0114:"NtWriteRequestData",
	0x0115:"NtWriteVirtualMemory",
	0x0116:"NtYieldExecution",
}

class SyscallControl(ProcessControl):
	""" Syscall hooking class """
	PREFIX = "syscall"
	hook_syscalls = [
			"NtTerminateProcess",
			"NtCreateThread",
			"NtTerminateThread",
			"NtCreateProcess",
			"NtCreateProcessEx",
			]

	def __init__(self, process, options):
		self.number_to_syscall_name = syscall_table
		self.name_to_syscall_number = {}
		for key, value in syscall_table.items():
			self.name_to_syscall_number[value] = key
		ProcessControl.__init__(self, process, options)

	def getSyscallByNumber(self, number):
		return self.number_to_syscall_name[number]

	def getSyscallByName(self, name):
		return self.name_to_syscall_number[name]

	def setupCallbacks(self):
		self.process.onInstrumentationInit(lambda: self.registerSyscallHooks(self.process))
		self.process.onInstrumentationInit(lambda: self.process.hardware.instrumentation.syscall_enable())
		self.process.onInstrumentationStop(lambda: self.dump_process(self.process))
		self.attach("syscall", self.onSyscallEvent)

	def registerSyscallHooks(self, process):
		for syscall in self.hook_syscalls:
			self.process.hardware.instrumentation.syscall_hook(self.getSyscallByName(syscall))

	def onSyscallEvent(self, process, event):
		print "Syscall - %s"%self.getSyscallByNumber(event.number)

	def dump_process(self, process):
		try:
			print "Dumping process: %s"%process.imagefilename()
		except:
			print "Process terminated - not dumping"
			return
		x = 0
		while x < 0x80000000:
			page = process.hardware.instrumentation.read_process_page(process, x)
			if page == None:
				x+=4096
				continue
			print "Dumping page: 0x%x"%x
			f = open(self.options["dump"]+"/0x%x"%x, "w")
			f.write(page)
			f.close()
			x += 4096

control = SyscallControl
